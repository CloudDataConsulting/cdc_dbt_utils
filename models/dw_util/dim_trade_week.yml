version: 2

models:
  - name: dim_trade_week
    description: |
      Trade calendar week dimension table containing one row per trade week, derived from dim_trade_date.

      Column naming follows CDC standards:
      - _dt for dates/timestamps
      - _num for numbers
      - _flg for boolean flags
      - _nm for names
      - _key for any primary or foreign keys in YYYYMMDD format
      - _txt for text strings

    columns:
      - name: trade_week_key
        description: "Primary key using the trade_year_num * 100 + trade_week_num (yyyymm format)"
        data_tests:
          - unique
          - not_null

      - name: trade_year_num
        description: "Trade year"
        data_tests:
          - not_null

      - name: trade_week_num
        description: "Trade week number within the year (1-52 or 1-53 for leap weeks)"
        data_tests:
          - not_null
          - accepted_values:
              values: [-1, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47, 48, 49, 50, 51, 52, 53]

      # - name: trade_year_week_num
      #   description: "Trade year and week as integer (YYYYWW format)"
      #   data_tests:
      #     - not_null

      - name: trade_week_start_dt
        description: "First day (Sunday) of the trade week"
        data_tests:
          - not_null

      - name: trade_week_start_key
        description: "Date key (YYYYMMDD) of the trade week's Sunday"
        data_tests:
          - not_null

      - name: trade_week_end_dt
        description: "Last day (Saturday) of the trade week"
        data_tests:
          - not_null

      - name: trade_week_end_key
        description: "Date key (YYYYMMDD) of the trade week's Saturday"
        data_tests:
          - not_null

      - name: trade_week_overall_num
        description: "Sequential trade week number since earliest trade week"
        data_tests:
          - not_null

      - name: trade_quarter_num
        description: "Trade quarter number (1-4)"
        data_tests:
          - not_null
          - accepted_values:
              values: [-1, 1, 2, 3, 4]

      - name: trade_quarter_nm
        description: "Trade quarter name short (Q1, Q2, Q3, Q4)"
        data_tests:
          - not_null
          - accepted_values:
              values: ['Q1', 'Q2', 'Q3', 'Q4', 'UNK']

      - name: trade_quarter_full_nm
        description: "Trade quarter name full (First, Second, Third, Fourth)"
        data_tests:
          - not_null
          - accepted_values:
              values: ['First', 'Second', 'Third', 'Fourth', 'Unknown']

      - name: trade_leap_week_flg
        description: "Flag indicating if this is the 53rd week (leap week)"
        data_tests:
          - not_null

      - name: weeks_in_trade_year_num
        description: "Total number of weeks in the trade year (52 or 53)"
        data_tests:
          - not_null
          - accepted_values:
              values: [-1, 52, 53]

      - name: trade_week_label
        description: "Week label (e.g., 'W01')"
        data_tests:
          - not_null

      - name: trade_week_full_label
        description: "Full week label (e.g., '2023-W01')"
        data_tests:
          - not_null

      - name: days_in_week
        description: "Number of days in the week (always 7 for complete weeks)"
        data_tests:
          - not_null
          - accepted_values:
              values: [0, 7]  # 0 for special records, 7 for regular

      - name: prior_trade_week_key
        description: "Key for the prior trade week"

      - name: next_trade_week_key
        description: "Key for the next trade week"

      - name: trade_week_last_year_key
        description: "Key for the same week last year"

    data_tests:
      # Test that trade week end date is 6 days after start
      - dbt_utils.expression_is_true:
          expression: "datediff(day, trade_week_start_dt, trade_week_end_dt) = 6"
          config:
            where: "trade_week_key > 0"
            error_if: ">0"
