version: 2

models:
  - name: dim_trade_week
    description: |
      Trade calendar week dimension table containing one row per trade week, derived from dim_trade_date for consistency.
      Provides week-level aggregations and attributes for retail/trade calendar analysis at weekly granularity.
      Includes all three common retail patterns (445, 454, 544) in a single table.
      
      Column naming follows CDC standards:
      - _dt for dates/timestamps
      - _num for numbers
      - _flg for boolean flags
      - _nm for names
      - _key for date keys in YYYYMMDD format
      - _txt for text strings
      
      Key Features:
      - Single table with all three patterns (445, 454, 544)
      - Columns suffixed with pattern type (_445_num, _454_num, _544_num)
      - Derived from dim_trade_date to ensure consistency
      - Trade weeks run Sunday to Saturday following retail calendar conventions
      
      Pattern Details:
      - 445: Each quarter has 4-4-5 week months (13 weeks per quarter)
      - 454: Each quarter has 4-5-4 week months (13 weeks per quarter)  
      - 544: Each quarter has 5-4-4 week months (13 weeks per quarter)
    
    columns:
      - name: trade_week_key
        description: "Primary key as trade year * 100 + trade week number (e.g., 202353 for trade year 2023, week 53)"
        data_tests:
          - unique
          - not_null
      
      # Week dates
      - name: trade_week_start_dt
        description: "First day (Sunday) of the trade week"
        data_tests:
          - not_null
      
      - name: trade_week_end_dt
        description: "Last day (Saturday) of the trade week"
        data_tests:
          - not_null
      
      - name: trade_week_end_key
        description: "Date key (YYYYMMDD) of the trade week's Saturday"
      
      # Core trade calendar
      - name: trade_year_num
        description: "Trade year (same for all patterns)"
        data_tests:
          - not_null
      
      - name: trade_week_num
        description: "Trade week number within the year (1-52 or 1-53 for leap weeks)"
        data_tests:
          - not_null
          - accepted_values:
              values: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47, 48, 49, 50, 51, 52, 53]
      
      # 445 Pattern attributes
      - name: trade_month_445_num
        description: "Trade month for 4-4-5 pattern (1-12)"
        data_tests:
          - not_null
          - accepted_values:
              values: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12]
      
      - name: trade_month_445_nm
        description: "Trade month name for 4-4-5 pattern"
        data_tests:
          - not_null
      
      - name: trade_quarter_445_num
        description: "Trade quarter for 4-4-5 pattern (1-4)"
        data_tests:
          - not_null
          - accepted_values:
              values: [1, 2, 3, 4]
      
      - name: trade_quarter_nm
        description: "Trade quarter name for 4-4-5 pattern (First, Second, Third, Fourth)"
        data_tests:
          - not_null
      
      - name: trade_week_of_month_445_num
        description: "Week number within the month for 4-4-5 pattern"
        data_tests:
          - not_null
      
      - name: trade_week_of_quarter_num
        description: "Week number within the quarter (1-13, or 14 for leap weeks) - same for all patterns"
        data_tests:
          - not_null
      
      # 454 Pattern attributes
      - name: trade_month_454_num
        description: "Trade month for 4-5-4 pattern (1-12)"
        data_tests:
          - not_null
          - accepted_values:
              values: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12]
      
      - name: trade_month_454_nm
        description: "Trade month name for 4-5-4 pattern"
        data_tests:
          - not_null
      
      - name: trade_quarter_454_num
        description: "Trade quarter for 4-5-4 pattern (1-4)"
        data_tests:
          - not_null
          - accepted_values:
              values: [1, 2, 3, 4]
      
      
      - name: trade_week_of_month_454_num
        description: "Week number within the month for 4-5-4 pattern"
        data_tests:
          - not_null
      
      
      # 544 Pattern attributes
      - name: trade_month_544_num
        description: "Trade month for 5-4-4 pattern (1-12)"
        data_tests:
          - not_null
          - accepted_values:
              values: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12]
      
      - name: trade_month_544_nm
        description: "Trade month name for 5-4-4 pattern"
        data_tests:
          - not_null
      
      - name: trade_quarter_544_num
        description: "Trade quarter for 5-4-4 pattern (1-4)"
        data_tests:
          - not_null
          - accepted_values:
              values: [1, 2, 3, 4]
      
      
      - name: trade_week_of_month_544_num
        description: "Week number within the month for 5-4-4 pattern"
        data_tests:
          - not_null
      
      
      # Week descriptions (445 pattern as default)
      - name: trade_month_year_445_nm
        description: "Month and year description for 4-4-5 pattern (e.g., 'January 2023')"
      
      - name: trade_week_of_month_445_txt
        description: "Descriptive text for week of month in 4-4-5 pattern (e.g., 'Week 2 of January')"
      
      - name: trade_week_year_txt
        description: "Trade week and year text (e.g., 'TW01 2023')"
      
      # Week descriptions (454 pattern)
      - name: trade_month_year_454_nm
        description: "Month and year description for 4-5-4 pattern (e.g., 'January 2023')"
      
      - name: trade_week_of_month_454_txt
        description: "Descriptive text for week of month in 4-5-4 pattern (e.g., 'Week 2 of January')"
      
      # Week descriptions (544 pattern)
      - name: trade_month_year_544_nm
        description: "Month and year description for 5-4-4 pattern (e.g., 'January 2023')"
      
      - name: trade_week_of_month_544_txt
        description: "Descriptive text for week of month in 5-4-4 pattern (e.g., 'Week 2 of January')"
      
      # Flags and indicators
      - name: is_trade_leap_week_flg
        description: "Flag indicating if this is the 53rd week (leap week)"
      
      - name: is_current_trade_week_flg
        description: "Flag indicating if this is the current trade week"
      
      - name: is_prior_trade_week_flg
        description: "Flag indicating if this is the prior trade week"
      
      - name: is_current_trade_year_flg
        description: "Flag indicating if this week is in the current trade year"
      
      # Relative metrics
      - name: trade_weeks_ago_num
        description: "Number of trade weeks ago from current date (negative for future weeks)"
      
      - name: trade_week_pct_of_year_num
        description: "Percentage of trade year completed as of this week (0.0-100.0)"
      
      # Week metrics
      - name: days_in_week_num
        description: "Number of days in the week (always 7 for complete weeks)"
        data_tests:
          - not_null
          - accepted_values:
              values: [7]
              config:
                where: "trade_year_num < 2041"  # Exclude partial year data
      
      - name: weeks_in_trade_year_num
        description: "Total number of weeks in the trade year (52 or 53)"
        data_tests:
          - not_null
          - accepted_values:
              values: [52, 53]
      
      - name: trade_week_overall_num
        description: "Sequential trade week number since earliest trade week, useful for week-over-week calculations"
        data_tests:
          - not_null
      
      # ETL metadata
      - name: dw_synced_ts
        description: "Timestamp when record was created/updated"
        data_tests:
          - not_null
      
      - name: dw_source_nm
        description: "Source system name"
      
      - name: create_user_id
        description: "User who created the record"
        data_tests:
          - not_null
      
      - name: create_timestamp
        description: "Timestamp when record was created"
        data_tests:
          - not_null
    
    data_tests:
      # Test 445 pattern: months 1,4,7,10 have max 4 weeks; 2,5,8,11 have max 4 weeks; 3,6,9,12 have max 5 weeks
      - dbt_utils.expression_is_true:
          expression: |
            case 
              when trade_month_445_num in (1, 4, 7, 10) then trade_week_of_month_445_num <= 4
              when trade_month_445_num in (2, 5, 8, 11) then trade_week_of_month_445_num <= 4
              when trade_month_445_num in (3, 6, 9, 12) then trade_week_of_month_445_num <= 5
              else false
            end
          config:
            where: "is_trade_leap_week_flg = false"  # Exclude leap weeks from this test
            error_if: ">0"
      
      # Test 454 pattern: months 1,4,7,10 have max 4 weeks; 2,5,8,11 have max 5 weeks; 3,6,9,12 have max 4 weeks
      - dbt_utils.expression_is_true:
          expression: |
            case 
              when trade_month_454_num in (1, 4, 7, 10) then trade_week_of_month_454_num <= 4
              when trade_month_454_num in (2, 5, 8, 11) then trade_week_of_month_454_num <= 5
              when trade_month_454_num in (3, 6, 9, 12) then trade_week_of_month_454_num <= 4
              else false
            end
          config:
            where: "is_trade_leap_week_flg = false"  # Exclude leap weeks from this test
            error_if: ">0"
      
      # Test 544 pattern: months 1,4,7,10 have max 5 weeks; 2,5,8,11 have max 4 weeks; 3,6,9,12 have max 4 weeks
      - dbt_utils.expression_is_true:
          expression: |
            case 
              when trade_month_544_num in (1, 4, 7, 10) then trade_week_of_month_544_num <= 5
              when trade_month_544_num in (2, 5, 8, 11) then trade_week_of_month_544_num <= 4
              when trade_month_544_num in (3, 6, 9, 12) then trade_week_of_month_544_num <= 4
              else false
            end
          config:
            where: "is_trade_leap_week_flg = false"  # Exclude leap weeks from this test
            error_if: ">0"
      
      # Test that all patterns have reasonable values for week of month (1-6, allowing for leap weeks)
      - dbt_utils.expression_is_true:
          expression: |
            trade_week_of_month_445_num between 1 and 6
            and trade_week_of_month_454_num between 1 and 6
            and trade_week_of_month_544_num between 1 and 6
          config:
            error_if: ">0"
      
      # Test that all patterns have reasonable values for week of quarter (1-14, allowing for leap weeks)
      - dbt_utils.expression_is_true:
          expression: |
            trade_week_of_quarter_num between 1 and 14
          config:
            error_if: ">0"
      
      # Test that trade week end date is exactly 6 days after start date
      - dbt_utils.expression_is_true:
          expression: "datediff(day, trade_week_start_dt, trade_week_end_dt) = 6"
          config:
            error_if: ">0"
      
      # Test that trade week key matches year and week components
      - dbt_utils.expression_is_true:
          expression: "trade_week_key = trade_year_num * 100 + trade_week_num"
          config:
            error_if: ">0"