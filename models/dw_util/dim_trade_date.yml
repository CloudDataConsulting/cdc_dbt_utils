version: 2

models:
  - name: dim_trade_date
    description: |
      Trade date dimension table with all three common patterns (445, 454, 544).
      This model provides trade_week_of_month calculations for all patterns in a single table,
      making it easy to support different retail calendar requirements without multiple models.

      Column naming follows CDC standards:
      - _dt for dates/timestamps
      - _num for numbers
      - _flg for boolean flags
      - _nm for names
      - _key for date keys (YYYYMMDD format)
      - _txt for text strings
      - _abbr for abbreviations

      Key Features:
      - Single table with all three patterns
      - Columns suffixed with pattern type (_445_num, _454_num, _544_num)
      - No configuration or lookups needed - all patterns always available
      - Designed for cdc_dbt_utils package
      - Multiple year-over-year comparison methods for 53-week year handling

      Pattern Details:
      - 445: Each quarter has 4-4-5 week months (13 weeks per quarter)
      - 454: Each quarter has 4-5-4 week months (13 weeks per quarter)
      - 544: Each quarter has 5-4-4 week months (13 weeks per quarter)

      Year-over-Year Comparison Methods:
      - NRF Standard: Week 53 maps to prior year week 52
      - Walmart Method: Week 53 maps to same year week 1
      - 364-Day Method: Always compare to exactly 52 weeks (364 days) prior

    columns:
      # Primary Key
      - name: date_key
        description: Date in YYYYMMDD format as integer
        data_tests:
          - unique
          - not_null

      # DAY Level (Most Granular)
      # Core day identifiers
      - name: full_dt
        description: Full trade date value (same as calendar_full_dt for reference)
        data_tests:
          - not_null

      # Year-over-year comparison keys
      - name: trade_date_last_year_nrf_key
        description: NRF standard method - Week 53 maps to prior year week 52, maintaining holiday alignment

      - name: trade_date_last_year_walmart_key
        description: Walmart method - Week 53 maps to same year week 1 for comparison

      - name: trade_date_last_year_364_key
        description: 364-day method - Always exactly 52 weeks (364 days) prior, same day of week

      # Day position metrics
      - name: trade_day_of_year_num
        description: Day number within the trade year (1-364 or 1-371)
        data_tests:
          - not_null

      - name: trade_day_of_quarter_num
        description: Day number within the trade quarter (1-91 or 1-98)
        data_tests:
          - not_null

      # WEEK Level
      # Week numbers
      - name: trade_week_num
        description: Trade week number within the year (1-52 or 1-53)
        data_tests:
          - not_null

      - name: trade_week_of_year_num
        description: Trade week number within the year (1-52 or 1-53), same as trade_week_num
        data_tests:
          - not_null

      - name: trade_week_of_month_445_num
        description: Week number within the month for 4-4-5 pattern
        data_tests:
          - not_null

      - name: trade_week_of_month_454_num
        description: Week number within the month for 4-5-4 pattern
        data_tests:
          - not_null

      - name: trade_week_of_month_544_num
        description: Week number within the month for 5-4-4 pattern
        data_tests:
          - not_null

      - name: trade_week_of_quarter_num
        description: Week number within the trade quarter (1-13, or 14 for leap weeks)
        data_tests:
          - not_null

      - name: trade_week_overall_num
        description: Sequential trade week number since 1970-01-01
        data_tests:
          - not_null

      # Week boundaries
      - name: trade_week_start_dt
        description: Start date of the trade week (Sunday)
        data_tests:
          - not_null

      - name: trade_week_start_key
        description: Date key of trade week start (YYYYMMDD)
        data_tests:
          - not_null

      - name: trade_week_end_dt
        description: End date of the trade week (Saturday)
        data_tests:
          - not_null

      - name: trade_week_end_key
        description: Date key of trade week end (YYYYMMDD)
        data_tests:
          - not_null

      # MONTH Level
      # Month identifiers
      - name: trade_month_445_num
        description: Trade month for 4-4-5 pattern
        data_tests:
          - not_null
          - accepted_values:
              values: [-3, -2, -1, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12]

      - name: trade_month_454_num
        description: Trade month for 4-5-4 pattern
        data_tests:
          - not_null
          - accepted_values:
              values: [-3, -2, -1, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12]

      - name: trade_month_544_num
        description: Trade month for 5-4-4 pattern
        data_tests:
          - not_null
          - accepted_values:
              values: [-3, -2, -1, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12]

      - name: trade_month_445_nm
        description: Trade month name for 4-4-5 pattern
        data_tests:
          - not_null

      - name: trade_month_454_nm
        description: Trade month name for 4-5-4 pattern
        data_tests:
          - not_null

      - name: trade_month_544_nm
        description: Trade month name for 5-4-4 pattern
        data_tests:
          - not_null

      - name: trade_month_abbr
        description: Three-letter trade month abbreviation
        data_tests:
          - not_null

      # Month metrics
      - name: trade_month_overall_num
        description: Sequential trade month number since 1990-01-01
        data_tests:
          - not_null

      - name: trade_yearmonth_num
        description: Trade year-month as YYYYMM integer
        data_tests:
          - not_null

      # Month boundaries
      - name: trade_month_445_start_dt
        description: Start date of the trade month for 4-4-5 pattern
        data_tests:
          - not_null

      - name: trade_month_454_start_dt
        description: Start date of the trade month for 4-5-4 pattern
        data_tests:
          - not_null

      - name: trade_month_544_start_dt
        description: Start date of the trade month for 5-4-4 pattern
        data_tests:
          - not_null

      - name: trade_month_445_start_key
        description: Date key of trade month start for 4-4-5 pattern (YYYYMMDD)
        data_tests:
          - not_null

      - name: trade_month_454_start_key
        description: Date key of trade month start for 4-5-4 pattern (YYYYMMDD)
        data_tests:
          - not_null

      - name: trade_month_544_start_key
        description: Date key of trade month start for 5-4-4 pattern (YYYYMMDD)
        data_tests:
          - not_null

      - name: trade_month_445_end_dt
        description: End date of the trade month for 4-4-5 pattern
        data_tests:
          - not_null

      - name: trade_month_454_end_dt
        description: End date of the trade month for 4-5-4 pattern
        data_tests:
          - not_null

      - name: trade_month_544_end_dt
        description: End date of the trade month for 5-4-4 pattern
        data_tests:
          - not_null

      - name: trade_month_445_end_key
        description: Date key of trade month end for 4-4-5 pattern (YYYYMMDD)
        data_tests:
          - not_null

      - name: trade_month_454_end_key
        description: Date key of trade month end for 4-5-4 pattern (YYYYMMDD)
        data_tests:
          - not_null

      - name: trade_month_544_end_key
        description: Date key of trade month end for 5-4-4 pattern (YYYYMMDD)
        data_tests:
          - not_null

      # QUARTER Level
      # Quarter identifiers
      - name: trade_quarter_num
        description: Trade quarter (1-4) - same for all patterns
        data_tests:
          - not_null
          - accepted_values:
              values: [-3, -2, -1, 1, 2, 3, 4]

      - name: trade_quarter_nm
        description: Trade quarter name (Q1, Q2, Q3, Q4)
        data_tests:
          - not_null
          - accepted_values:
              values: ['Q1', 'Q2', 'Q3', 'Q4', 'N/A', 'INV', 'UNK']

      - name: trade_quarter_full_nm
        description: Trade quarter name (First, Second, Third, Fourth)
        data_tests:
          - not_null
          - accepted_values:
              values: ['First', 'Second', 'Third', 'Fourth', 'Not Applicable', 'Invalid', 'Unknown']

      # Quarter boundaries
      - name: trade_quarter_start_dt
        description: Start date of the trade quarter (same for all patterns)
        data_tests:
          - not_null

      - name: trade_quarter_start_key
        description: Date key of trade quarter start (YYYYMMDD)
        data_tests:
          - not_null

      - name: trade_quarter_end_dt
        description: End date of the trade quarter (same for all patterns)
        data_tests:
          - not_null

      - name: trade_quarter_end_key
        description: Date key of trade quarter end (YYYYMMDD)
        data_tests:
          - not_null

      # YEAR Level
      # Year identifiers
      - name: trade_year_num
        description: Trade year (same for all patterns)
        data_tests:
          - not_null

      # Year boundaries
      - name: trade_year_start_dt
        description: Start date of the trade year
        data_tests:
          - not_null

      - name: trade_year_start_key
        description: Date key of trade year start (YYYYMMDD)
        data_tests:
          - not_null

      - name: trade_year_end_dt
        description: End date of the trade year
        data_tests:
          - not_null

      - name: trade_year_end_key
        description: Date key of trade year end (YYYYMMDD)
        data_tests:
          - not_null

      # Year and quarter metrics
      - name: trade_leap_week_flg
        description: Flag indicating if this date falls in the 53rd trade week
        data_tests:
          - not_null

      - name: weeks_in_trade_year_num
        description: Total number of weeks in the trade year (52 or 53)
        data_tests:
          - not_null
          - accepted_values:
              values: [-3, -2, -1, 52, 53]

      - name: days_in_trade_year_num
        description: Total number of days in the trade year (364 or 371)
        data_tests:
          - not_null
          - accepted_values:
              values: [-3, -2, -1, 364, 371]

      - name: weeks_in_trade_quarter_num
        description: Total number of weeks in the trade quarter (13 or 14 for Q4 in leap years)
        data_tests:
          - not_null
          - accepted_values:
              values: [-3, -2, -1, 13, 14]

      - name: days_in_trade_quarter_num
        description: Total number of days in the trade quarter (91 or 98 for Q4 in leap years)
        data_tests:
          - not_null
          - accepted_values:
              values: [-3, -2, -1, 91, 98]

      # Metadata Columns
      - name: dw_synced_ts
        description: Timestamp when record was created/updated
        data_tests:
          - not_null

      - name: dw_source_nm
        description: Source system name
        data_tests:
          - not_null

      - name: create_user_id
        description: User who created the record
        data_tests:
          - not_null

      - name: create_ts
        description: Timestamp when record was created
        data_tests:
          - not_null

    data_tests:
      # Test 445 pattern: months 1,4,7,10 have max 4 weeks; 2,5,8,11 have max 4 weeks; 3,6,9,12 have max 5 weeks
      - dbt_utils.expression_is_true:
          expression: |
            case
              when trade_month_445_num in (1, 4, 7, 10) then trade_week_of_month_445_num <= 4
              when trade_month_445_num in (2, 5, 8, 11) then trade_week_of_month_445_num <= 4
              when trade_month_445_num in (3, 6, 9, 12) then trade_week_of_month_445_num <= 5
              else false
            end
          config:
            where: "trade_leap_week_flg = false and date_key >0" # Exclude leap weeks
            error_if: ">0"

      # Test 454 pattern: months 1,4,7,10 have max 4 weeks; 2,5,8,11 have max 5 weeks; 3,6,9,12 have max 4 weeks
      - dbt_utils.expression_is_true:
          expression: |
            case
              when trade_month_454_num in (1, 4, 7, 10) then trade_week_of_month_454_num <= 4
              when trade_month_454_num in (2, 5, 8, 11) then trade_week_of_month_454_num <= 5
              when trade_month_454_num in (3, 6, 9, 12) then trade_week_of_month_454_num <= 4
              else false
            end
          config:
            where: "trade_leap_week_flg = false  and date_key >0" # Exclude leap weeks
            error_if: ">0"

      # Test 544 pattern: months 1,4,7,10 have max 5 weeks; 2,5,8,11 have max 4 weeks; 3,6,9,12 have max 4 weeks
      - dbt_utils.expression_is_true:
          expression: |
            case
              when trade_month_544_num in (1, 4, 7, 10) then trade_week_of_month_544_num <= 5
              when trade_month_544_num in (2, 5, 8, 11) then trade_week_of_month_544_num <= 4
              when trade_month_544_num in (3, 6, 9, 12) then trade_week_of_month_544_num <= 4
              else false
            end
          config:
            where: "trade_leap_week_flg = false  and date_key >0" # Exclude leap weeks
            error_if: ">0"

      # Test that all patterns have values between 1 and 6 (6 for leap week months)
      - dbt_utils.expression_is_true:
          expression: |
            trade_week_of_month_445_num between 1 and 6
            and trade_week_of_month_454_num between 1 and 6
            and trade_week_of_month_544_num between 1 and 6
          config:
            where: "date_key >0"  # Exclude special rows
            error_if: ">0"

      # Test that year-over-year comparison keys point to valid dates when not null
      - dbt_utils.expression_is_true:
          expression: |
            (trade_date_last_year_nrf_key is null or trade_date_last_year_nrf_key between 19990101 and 20301231)
            and (trade_date_last_year_walmart_key is null or trade_date_last_year_walmart_key between 20000101 and 20301231)
            and (trade_date_last_year_364_key is null or trade_date_last_year_364_key between 19990101 and 20301231)
          config:
            where: "trade_year_num >= 2000 and date_key >0"
            error_if: ">0"

      # Test that days_in_trade_year_num is correct (364 for 52-week years, 371 for 53-week years)
      - dbt_utils.expression_is_true:
          expression: |
            (weeks_in_trade_year_num = 52 and days_in_trade_year_num = 364)
            or (weeks_in_trade_year_num = 53 and days_in_trade_year_num = 371)
          config:
            where: "date_key >0"  # Exclude special rows
            error_if: ">0"

      # Test that days_in_trade_quarter_num is correct (91 for regular quarters, 98 for Q4 in 53-week years)
      - dbt_utils.expression_is_true:
          expression: |
            (weeks_in_trade_quarter_num = 13 and days_in_trade_quarter_num = 91)
            or (weeks_in_trade_quarter_num = 14 and days_in_trade_quarter_num = 98)
          config:
            where: "date_key >0"  # Exclude special rows
            error_if: ">0"

      # Test that year-over-year comparison keys maintain consistent year progression
      # This test catches issues where the year might incorrectly revert (e.g., 2025 -> 2024 -> 2025)
      - dbt_utils.expression_is_true:
          expression: |
            -- For NRF method: should be from prior year or same year (for week 53) or null
            (trade_date_last_year_nrf_key is null 
             or floor(trade_date_last_year_nrf_key / 10000) <= trade_year_num)
          config:
            where: "date_key > 0 and trade_year_num >= 2001"  # Start from 2001 to ensure prior year exists
            error_if: ">0"
            severity: error

      # Test to ensure Walmart method doesn't have year reversions in 53-week years
      # Specifically: week 53 should point to next year, not same year
      - dbt_utils.expression_is_true:
          expression: |
            -- For week 53, the Walmart key should be from the next year (week 1)
            -- This test only runs on dates that are actually in week 53
            (trade_date_last_year_walmart_key is null 
             or floor(trade_date_last_year_walmart_key / 10000) = trade_year_num + 1)
          config:
            where: "date_key > 0 and trade_week_num = 53 and trade_year_num <= 2029"  # Only week 53 dates where next year exists
            error_if: ">0"
            severity: error
