version: 2

models:
  - name: dim_trade_quarter
    description: |
      Trade calendar quarter dimension table containing one row per trade quarter, derived from dim_trade_month for consistency.
      Provides quarter-level aggregations and attributes for retail/trade calendar analysis at quarterly granularity.

      Since all trade calendar patterns have identical quarterly structure (13 weeks per quarter),
      this model has a single record per trade quarter.

      Column naming follows CDC standards:
      - _dt for dates/timestamps
      - _num for numbers
      - _flg for boolean flags
      - _nm for names
      - _key for keys in YYYYMMDD or YYYYQQ format
      - _txt for text strings
      - _abbr for abbreviations

      Key Features:
      - Single record per trade quarter (patterns are identical at quarter level)
      - Derived from dim_trade_month to ensure consistency
      - Includes special records (-1: Unknown, -2: Invalid, -3: Not Applicable)
      - Navigation keys for time series analysis
      - All patterns have 13 weeks per quarter (14 weeks in Q4 for 53-week years)
      - Multiple year-over-year comparison methods for handling 53-week years

      Pattern Details:
      - 445: Each quarter has 4-4-5 week months (13 weeks per quarter)
      - 454: Each quarter has 4-5-4 week months (13 weeks per quarter)
      - 544: Each quarter has 5-4-4 week months (13 weeks per quarter)

      Year-over-Year Comparison Methods:
      - NRF Standard: Q4 with week 53 maps to Q4 of prior year
      - Walmart Method: Standard quarter-to-quarter mapping
      - 4-Quarter Method: Always compare to exactly 4 quarters prior

    columns:
      # Primary key
      - name: trade_quarter_key
        description: "Primary key as YYYYQQ format (e.g., 202301 for 2023 Q1)"
        data_tests:
          - unique
          - not_null

      # Core identifiers
      - name: trade_year_num
        description: "Trade year"
        data_tests:
          - not_null

      - name: trade_quarter_num
        description: "Trade quarter number within the year (1-4)"
        data_tests:
          - not_null
          - accepted_values:
              values: [-3, -2, -1, 1, 2, 3, 4]

      - name: trade_quarter_nm
        description: "Trade quarter name short (Q1, Q2, Q3, Q4)"
        data_tests:
          - not_null

      - name: trade_quarter_full_nm
        description: "Trade quarter name full (First, Second, Third, Fourth)"
        data_tests:
          - not_null

      # Quarter boundaries
      - name: trade_quarter_start_dt
        description: "First day (Sunday) of the trade quarter"
        data_tests:
          - not_null

      - name: trade_quarter_end_dt
        description: "Last day (Saturday) of the trade quarter"
        data_tests:
          - not_null

      - name: trade_quarter_start_key
        description: "Date key (YYYYMMDD) of the trade quarter's first day"
        data_tests:
          - not_null

      - name: trade_quarter_end_key
        description: "Date key (YYYYMMDD) of the trade quarter's last day"
        data_tests:
          - not_null

      # Month metrics
      - name: first_month_of_quarter_num
        description: "Trade month number of the first month in this quarter"
        data_tests:
          - not_null

      - name: last_month_of_quarter_num
        description: "Trade month number of the last month in this quarter"
        data_tests:
          - not_null

      - name: months_in_quarter_num
        description: "Number of months in the quarter (normally 3)"
        data_tests:
          - not_null

      # Week metrics
      - name: weeks_in_quarter_num
        description: "Total number of weeks in the quarter (normally 13, 14 with leap week)"
        data_tests:
          - not_null
          - accepted_values:
              values: [-3, -2, -1, 13, 14]

      - name: first_week_of_quarter_num
        description: "Trade week number of the first week in this quarter"
        data_tests:
          - not_null

      - name: last_week_of_quarter_num
        description: "Trade week number of the last week in this quarter"
        data_tests:
          - not_null

      - name: trade_weeks_in_quarter_445_num
        description: "Number of weeks in quarter for 4-4-5 pattern"
        data_tests:
          - not_null

      - name: trade_weeks_in_quarter_454_num
        description: "Number of weeks in quarter for 4-5-4 pattern"
        data_tests:
          - not_null

      - name: trade_weeks_in_quarter_544_num
        description: "Number of weeks in quarter for 5-4-4 pattern"
        data_tests:
          - not_null

      # Day metrics
      - name: days_in_quarter_num
        description: "Total number of days in the quarter (normally 91, 98 with leap week)"
        data_tests:
          - not_null
          - accepted_values:
              values: [-3, -2, -1, 91, 98]

      # Year count metrics
      - name: weeks_in_trade_year_num
        description: "Total number of weeks in the trade year (52 or 53)"
        data_tests:
          - not_null
          - accepted_values:
              values: [-3, -2, -1, 52, 53]

      - name: days_in_trade_year_num
        description: "Total number of days in the trade year (364 or 371)"
        data_tests:
          - not_null
          - accepted_values:
              values: [-3, -2, -1, 364, 371]

      # Display formats
      - name: trade_quarter_txt
        description: "Trade quarter text (Q1, Q2, Q3, Q4)"
        data_tests:
          - not_null

      - name: trade_quarter_year_nm
        description: "Quarter and year description (e.g., 'Q1 2023')"
        data_tests:
          - not_null

      - name: trade_year_quarter_txt
        description: "Trade year and quarter text (e.g., 'TY2023-Q1')"
        data_tests:
          - not_null

      - name: year_quarter_txt
        description: "Simple year-quarter text (e.g., '2023-Q1')"
        data_tests:
          - not_null

      - name: trade_quarter_position_txt
        description: "Quarter position description (Q1 Quarter, Q2 Quarter, etc.)"
        data_tests:
          - not_null

      # Flags
      - name: contains_leap_week_flg
        description: "Flag indicating if this quarter contains the 53rd week (leap week)"
        data_tests:
          - not_null

      # Year context
      - name: trade_year_start_dt
        description: "Start date of the trade year"
        data_tests:
          - not_null

      - name: trade_year_start_key
        description: "Date key (YYYYMMDD) of the trade year start"
        data_tests:
          - not_null

      - name: trade_year_end_dt
        description: "End date of the trade year"
        data_tests:
          - not_null

      - name: trade_year_end_key
        description: "Date key (YYYYMMDD) of the trade year end"
        data_tests:
          - not_null

      # Overall numbering
      - name: trade_quarter_overall_num
        description: "Sequential trade quarter number since year 2000, useful for quarter-over-quarter calculations"
        data_tests:
          - not_null

      # Navigation keys
      - name: prior_trade_quarter_key
        description: "Key for the prior trade quarter"

      - name: next_trade_quarter_key
        description: "Key for the next trade quarter"

      - name: trade_quarter_last_year_nrf_key
        description: "NRF standard method - Q4 with week 53 maps to Q4 of prior year"

      - name: trade_quarter_last_year_walmart_key
        description: "Walmart method - Standard quarter-to-quarter mapping"

      - name: trade_quarter_last_year_4q_key
        description: "4-quarter method - Always exactly 4 quarters prior"

      # Metadata columns
      - name: dw_synced_ts
        description: "Timestamp when record was created/updated"
        data_tests:
          - not_null

      - name: dw_source_nm
        description: "Source system name"
        data_tests:
          - not_null

      - name: create_user_id
        description: "User who created the record"
        data_tests:
          - not_null

      - name: create_ts
        description: "Timestamp when record was created"
        data_tests:
          - not_null

    data_tests:
      # Test that trade quarter key follows expected format
      - dbt_utils.expression_is_true:
          expression: "trade_quarter_key = trade_year_num * 100 + trade_quarter_num"
          config:
            where: "trade_quarter_key > 0"
            error_if: ">0"

      # Test that first month of quarter is correct
      - dbt_utils.expression_is_true:
          expression: |
            case
              when trade_quarter_num = 1 then first_month_of_quarter_num = 1
              when trade_quarter_num = 2 then first_month_of_quarter_num = 4
              when trade_quarter_num = 3 then first_month_of_quarter_num = 7
              when trade_quarter_num = 4 then first_month_of_quarter_num = 10
              else true
            end
          config:
            where: "trade_quarter_key > 0"
            error_if: ">0"

      # Test that last month of quarter is correct
      - dbt_utils.expression_is_true:
          expression: |
            case
              when trade_quarter_num = 1 then last_month_of_quarter_num = 3
              when trade_quarter_num = 2 then last_month_of_quarter_num = 6
              when trade_quarter_num = 3 then last_month_of_quarter_num = 9
              when trade_quarter_num = 4 then last_month_of_quarter_num = 12
              else true
            end
          config:
            where: "trade_quarter_key > 0"
            error_if: ">0"

      # Test that days in quarter aligns with weeks (7 days per week)
      - dbt_utils.expression_is_true:
          expression: "days_in_quarter_num = weeks_in_quarter_num * 7"
          config:
            where: "trade_quarter_key > 0"
            error_if: ">0"

      # Test that complete quarters without leap weeks have exactly 13 weeks
      - dbt_utils.expression_is_true:
          expression: "weeks_in_quarter_num = 13"
          config:
            where: "trade_quarter_key > 0 and contains_leap_week_flg = 0"
            error_if: ">0"

      # Test that quarters with leap weeks have 14 weeks
      - dbt_utils.expression_is_true:
          expression: "weeks_in_quarter_num = 14"
          config:
            where: "trade_quarter_key > 0 and contains_leap_week_flg = 1"
            error_if: ">0"

      # Test that only Q4 can have leap weeks (53rd week always falls in Q4)
      - dbt_utils.expression_is_true:
          expression: "trade_quarter_num = 4"
          config:
            where: "trade_quarter_key > 0 and contains_leap_week_flg = 1"
            error_if: ">0"

      # Test that quarter start dates are always Sundays
      - dbt_utils.expression_is_true:
          expression: "dayofweek(trade_quarter_start_dt) = 0"  # Sunday = 0 in Snowflake
          config:
            where: "trade_quarter_key > 0"
            error_if: ">0"

      # Test that quarter end dates are always Saturdays
      - dbt_utils.expression_is_true:
          expression: "dayofweek(trade_quarter_end_dt) = 6"  # Saturday = 6 in Snowflake
          config:
            where: "trade_quarter_key > 0"
            error_if: ">0"

      # Test for prior quarter key validity
      - dbt_utils.expression_is_true:
          expression: |
            prior_trade_quarter_key is null
            or prior_trade_quarter_key < 0
            or prior_trade_quarter_key between 200001 and 203004
          config:
            where: "trade_quarter_key > 0"
            error_if: ">0"

      # Test for next quarter key validity
      - dbt_utils.expression_is_true:
          expression: |
            next_trade_quarter_key is null
            or next_trade_quarter_key < 0
            or next_trade_quarter_key between 200001 and 203004
          config:
            where: "trade_quarter_key > 0"
            error_if: ">0"

      # Test for last year quarter key validity - updated for three methods
      - dbt_utils.expression_is_true:
          expression: |
            (trade_quarter_last_year_nrf_key is null or trade_quarter_last_year_nrf_key < 0 or trade_quarter_last_year_nrf_key between 199901 and 203004)
            and (trade_quarter_last_year_walmart_key is null or trade_quarter_last_year_walmart_key < 0 or trade_quarter_last_year_walmart_key between 199901 and 203004)
            and (trade_quarter_last_year_4q_key is null or trade_quarter_last_year_4q_key < 0 or trade_quarter_last_year_4q_key between 199901 and 203004)
          config:
            where: "trade_quarter_key > 0"
            error_if: ">0"

      # Test that all pattern week counts are close (within 1 week difference)
      - dbt_utils.expression_is_true:
          expression: |
            abs(trade_weeks_in_quarter_445_num - trade_weeks_in_quarter_454_num) <= 1
            and abs(trade_weeks_in_quarter_454_num - trade_weeks_in_quarter_544_num) <= 1
            and abs(trade_weeks_in_quarter_445_num - trade_weeks_in_quarter_544_num) <= 1
          config:
            where: "trade_quarter_key > 0"
            error_if: ">0"

      # Test that months_in_quarter is always 3 for complete quarters
      - dbt_utils.expression_is_true:
          expression: "months_in_quarter_num = 3"
          config:
            where: "trade_quarter_key > 0"
            error_if: ">0"

      # Test that days_in_trade_year_num is correct
      - dbt_utils.expression_is_true:
          expression: |
            (weeks_in_trade_year_num = 52 and days_in_trade_year_num = 364)
            or (weeks_in_trade_year_num = 53 and days_in_trade_year_num = 371)
          config:
            where: "trade_quarter_key > 0"
            error_if: ">0"
