version: 2

models:
  - name: dim_date_retail
    description: |
      Retail calendar dimension table with all three common patterns (445, 454, 544).
      This model provides trade_week_of_month calculations for all patterns in a single table,
      making it easy to support different retail calendar requirements without multiple models.
      
      Column naming follows CDC standards:
      - _dt for dates/timestamps
      - _num for numbers
      - _flg for boolean flags
      - _nm for names
      - _ts for timestamps
      
      Key Features:
      - Single table with all three patterns
      - Columns suffixed with pattern type (_445_num, _454_num, _544_num)
      - No configuration or lookups needed - all patterns always available
      - Designed for cdc_dbt_utils package
      
      Pattern Details:
      - 445: Each quarter has 4-4-5 week months (13 weeks per quarter)
      - 454: Each quarter has 4-5-4 week months (13 weeks per quarter)  
      - 544: Each quarter has 5-4-4 week months (13 weeks per quarter)
    
    columns:
      - name: date_key
        description: Date in YYYYMMDD format as integer
        tests:
          - unique
          - not_null
      
      - name: full_dt
        description: Full date value
        tests:
          - not_null
      
      - name: same_dt_last_year
        description: Same date from the previous year for YoY comparisons
        tests:
          - not_null
      
      # Standard calendar columns with CDC naming
      - name: calendar_year_num
        description: Standard calendar year
        tests:
          - not_null
      
      - name: calendar_quarter_num
        description: Standard calendar quarter (1-4)
        tests:
          - not_null
      
      - name: calendar_month_num
        description: Standard calendar month (1-12)
        tests:
          - not_null
      
      - name: calendar_week_num
        description: Standard ISO week number
        tests:
          - not_null
      
      - name: day_of_week_num
        description: Day of week (0=Sunday through 6=Saturday)
        tests:
          - not_null
      
      - name: day_nm
        description: Day name abbreviation (Mon, Tue, etc.)
        tests:
          - not_null
      
      - name: day_abbr
        description: Three-letter day abbreviation (Mon, Tue, etc.)
        tests:
          - not_null
      
      - name: iso_day_of_week_num
        description: ISO day of week (1=Monday through 7=Sunday)
        tests:
          - not_null
      
      - name: weekday_flg
        description: Flag indicating Weekday or Weekend
        tests:
          - not_null
      
      - name: end_of_week_flg
        description: Binary flag for end of week (Sunday)
        tests:
          - not_null
      
      # Day attributes
      - name: day_suffix_txt
        description: Day with ordinal suffix (1st, 2nd, 3rd, etc.)
        tests:
          - not_null
      
      - name: day_overall_num
        description: Sequential day number since 1970-01-01
        tests:
          - not_null
      
      - name: day_of_month_num
        description: Day of the month (1-31)
        tests:
          - not_null
      
      - name: day_of_quarter_num
        description: Day number within the quarter (1-92)
        tests:
          - not_null
      
      - name: day_of_year_num
        description: Day of the year (1-365/366)
        tests:
          - not_null
      
      # Month attributes
      - name: month_nm
        description: Full month name (January, February, etc.)
        tests:
          - not_null
      
      - name: month_abbr
        description: Three-letter month abbreviation (Jan, Feb, etc.)
        tests:
          - not_null
      
      - name: month_num
        description: Month number (1-12)
        tests:
          - not_null
      
      - name: month_overall_num
        description: Sequential month number since 1970-01-01
        tests:
          - not_null
      
      - name: month_in_quarter_num
        description: Month position within quarter (1, 2, or 3)
        tests:
          - not_null
      
      - name: first_day_of_month
        description: First date of the month
        tests:
          - not_null
      
      - name: last_day_of_month
        description: Last date of the month
        tests:
          - not_null
      
      - name: first_day_of_month_flg
        description: Binary flag for first day of month
        tests:
          - not_null
      
      - name: end_of_month_flg
        description: Binary flag for last day of month
        tests:
          - not_null
      
      # Quarter attributes
      - name: quarter_nm
        description: Quarter name (First, Second, Third, Fourth)
        tests:
          - not_null
      
      - name: first_day_of_quarter
        description: First date of the quarter
        tests:
          - not_null
      
      - name: last_day_of_quarter
        description: Last date of the quarter
        tests:
          - not_null
      
      # Year attributes
      - name: iso_year_num
        description: ISO week year
        tests:
          - not_null
      
      - name: yearmonth_num
        description: Year-month as YYYYMM integer
        tests:
          - not_null
      
      - name: first_day_of_year_dt
        description: First date of the year (January 1)
        tests:
          - not_null
      
      - name: last_day_of_year_dt
        description: Last date of the year (December 31)
        tests:
          - not_null
      
      - name: end_of_year_flg
        description: Binary flag for last day of year
        tests:
          - not_null
      
      # Week attributes
      - name: week_of_year_num
        description: Week of the year (1-53)
        tests:
          - not_null
      
      - name: week_of_month_num
        description: Week of the month (1-5)
        tests:
          - not_null
      
      - name: iso_week_of_year_txt
        description: ISO week format (YYYY-Www-d)
        tests:
          - not_null
      
      - name: week_overall_num
        description: Sequential week number since 1970-01-01
        tests:
          - not_null
      
      - name: week_begin_dt
        description: First day (Monday) of the week
        tests:
          - not_null
      
      - name: week_begin_key
        description: Date key of week start (YYYYMMDD)
        tests:
          - not_null
      
      - name: week_end_dt
        description: Last day (Sunday) of the week
        tests:
          - not_null
      
      - name: week_end_key
        description: Date key of week end (YYYYMMDD)
        tests:
          - not_null
      
      # Other date formats
      - name: epoch
        description: Unix timestamp (seconds since 1970-01-01)
        tests:
          - not_null
      
      - name: yyyymmdd
        description: Date as YYYYMMDD integer
        tests:
          - not_null
      
      # Audit columns
      - name: create_user_id
        description: User who created the record
        tests:
          - not_null
      
      - name: create_timestamp
        description: Timestamp when record was created
        tests:
          - not_null
      
      # Core retail calendar columns (same for all patterns)
      - name: trade_year_num
        description: Retail/trade year (same for all patterns)
        tests:
          - not_null
      
      - name: trade_week_num
        description: Retail week number within the year (1-52 or 1-53)
        tests:
          - not_null
      
      - name: trade_week_start_dt
        description: Start date of the trade week
        tests:
          - not_null
      
      - name: trade_week_end_dt
        description: End date of the trade week
        tests:
          - not_null
      
      # Pattern-specific month columns
      - name: trade_month_445_num
        description: Retail month for 4-4-5 pattern
        tests:
          - not_null
          - accepted_values:
              values: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12]
      
      - name: trade_month_454_num
        description: Retail month for 4-5-4 pattern
        tests:
          - not_null
          - accepted_values:
              values: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12]
      
      - name: trade_month_544_num
        description: Retail month for 5-4-4 pattern
        tests:
          - not_null
          - accepted_values:
              values: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12]
      
      # Pattern-specific month name columns
      - name: trade_month_445_nm
        description: Retail month name for 4-4-5 pattern
        tests:
          - not_null
      
      - name: trade_month_454_nm
        description: Retail month name for 4-5-4 pattern
        tests:
          - not_null
      
      - name: trade_month_544_nm
        description: Retail month name for 5-4-4 pattern
        tests:
          - not_null
      
      # Pattern-specific quarter columns
      - name: trade_quarter_445_num
        description: Retail quarter for 4-4-5 pattern
        tests:
          - not_null
          - accepted_values:
              values: [1, 2, 3, 4]
      
      - name: trade_quarter_454_num
        description: Retail quarter for 4-5-4 pattern
        tests:
          - not_null
          - accepted_values:
              values: [1, 2, 3, 4]
      
      - name: trade_quarter_544_num
        description: Retail quarter for 5-4-4 pattern
        tests:
          - not_null
          - accepted_values:
              values: [1, 2, 3, 4]
      
      # Pattern-specific quarter name columns
      - name: trade_quarter_445_nm
        description: Retail quarter name for 4-4-5 pattern (First, Second, Third, Fourth)
        tests:
          - not_null
      
      - name: trade_quarter_454_nm
        description: Retail quarter name for 4-5-4 pattern (First, Second, Third, Fourth)
        tests:
          - not_null
      
      - name: trade_quarter_544_nm
        description: Retail quarter name for 5-4-4 pattern (First, Second, Third, Fourth)
        tests:
          - not_null
      
      # Pattern-specific week of month columns
      - name: trade_week_of_month_445_num
        description: Week number within the month for 4-4-5 pattern
        tests:
          - not_null
      
      - name: trade_week_of_month_454_num
        description: Week number within the month for 4-5-4 pattern
        tests:
          - not_null
      
      - name: trade_week_of_month_544_num
        description: Week number within the month for 5-4-4 pattern
        tests:
          - not_null
      
      # Pattern-specific week of quarter columns
      - name: trade_week_of_quarter_445_num
        description: Week number within the quarter for 4-4-5 pattern (1-13, or 14 for leap weeks)
        tests:
          - not_null
      
      - name: trade_week_of_quarter_454_num
        description: Week number within the quarter for 4-5-4 pattern (1-13, or 14 for leap weeks)
        tests:
          - not_null
      
      - name: trade_week_of_quarter_544_num
        description: Week number within the quarter for 5-4-4 pattern (1-13, or 14 for leap weeks)
        tests:
          - not_null
      
      # Trade week of year
      - name: trade_week_of_year_num
        description: Retail week number within the year (1-52 or 1-53), same for all patterns
        tests:
          - not_null
      
      # Common attributes
      - name: is_leap_week_flg
        description: Flag indicating if this date falls in the 53rd week
        tests:
          - not_null
      
      - name: weeks_in_trade_year_num
        description: Total number of weeks in the trade year (52 or 53)
        tests:
          - not_null
      
      - name: trade_day_of_year_num
        description: Day number within the trade year
        tests:
          - not_null
      
      # ETL metadata
      - name: dw_deleted_flg
        description: Soft delete flag
        tests:
          - not_null
      
      - name: dw_synced_ts
        description: Timestamp when record was created/updated
        tests:
          - not_null
      
      - name: dw_source_nm
        description: Source system name
        tests:
          - not_null
    
    tests:
      # Test 445 pattern: months 1,4,7,10 have max 4 weeks; 2,5,8,11 have max 4 weeks; 3,6,9,12 have max 5 weeks
      - dbt_utils.expression_is_true:
          expression: |
            case 
              when trade_month_445_num in (1, 4, 7, 10) then trade_week_of_month_445_num <= 4
              when trade_month_445_num in (2, 5, 8, 11) then trade_week_of_month_445_num <= 4
              when trade_month_445_num in (3, 6, 9, 12) then trade_week_of_month_445_num <= 5
              else false
            end
          config:
            where: "is_leap_week_flg = false"  # Exclude leap weeks
            error_if: ">0"
      
      # Test 454 pattern: months 1,4,7,10 have max 4 weeks; 2,5,8,11 have max 5 weeks; 3,6,9,12 have max 4 weeks
      - dbt_utils.expression_is_true:
          expression: |
            case 
              when trade_month_454_num in (1, 4, 7, 10) then trade_week_of_month_454_num <= 4
              when trade_month_454_num in (2, 5, 8, 11) then trade_week_of_month_454_num <= 5
              when trade_month_454_num in (3, 6, 9, 12) then trade_week_of_month_454_num <= 4
              else false
            end
          config:
            where: "is_leap_week_flg = false"  # Exclude leap weeks
            error_if: ">0"
      
      # Test 544 pattern: months 1,4,7,10 have max 5 weeks; 2,5,8,11 have max 4 weeks; 3,6,9,12 have max 4 weeks
      - dbt_utils.expression_is_true:
          expression: |
            case 
              when trade_month_544_num in (1, 4, 7, 10) then trade_week_of_month_544_num <= 5
              when trade_month_544_num in (2, 5, 8, 11) then trade_week_of_month_544_num <= 4
              when trade_month_544_num in (3, 6, 9, 12) then trade_week_of_month_544_num <= 4
              else false
            end
          config:
            where: "is_leap_week_flg = false"  # Exclude leap weeks
            error_if: ">0"
      
      # Test that all patterns have values between 1 and 6 (6 for leap week months)
      - dbt_utils.expression_is_true:
          expression: |
            trade_week_of_month_445_num between 1 and 6
            and trade_week_of_month_454_num between 1 and 6
            and trade_week_of_month_544_num between 1 and 6
          config:
            error_if: ">0"